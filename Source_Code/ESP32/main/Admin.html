<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ESP32 WiFi Config</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        padding: 20px;
    }

    h2 { text-align: center; }

    .center-btn {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    #wifiList {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .wifi-item {
        background: white;
        padding: 12px;
        width: 500px;
        margin-bottom: 8px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        border: 1px solid #ddd;
    }


    .wifi-name {
        font-size: 16px;
        font-weight: bold;
    }


    .icons {
        display: flex;
        gap: 10px;
        align-items: center;
    }


    .lock {
        color: #d9534f;
        font-size: 18px;
    }


    /* ICON S√ìNG WIFI KI·ªÇU iPHONE */
    .wifi-icon {
        width: 22px;
        height: 18px;
        position: relative;
        display: inline-block;
    }


    .wifi-icon span {
        position: absolute;
        bottom: 0;
        width: 4px;
        background: #000;
        border-radius: 2px;
        opacity: 0.2;
    }


    .wifi-icon .bar1 { height: 4px; left: 0px; }
    .wifi-icon .bar2 { height: 8px; left: 6px; }
    .wifi-icon .bar3 { height: 12px; left: 12px; }
    .wifi-icon .bar4 { height: 16px; left: 18px; }


    .wifi-signal-1 .bar1 { opacity: 1; }
    .wifi-signal-2 .bar1, .wifi-signal-2 .bar2 { opacity: 1; }
    .wifi-signal-3 .bar1, .wifi-signal-3 .bar2, .wifi-signal-3 .bar3 { opacity: 1; }
    .wifi-signal-4 .bar1, .wifi-signal-4 .bar2, .wifi-signal-4 .bar3, .wifi-signal-4 .bar4 { opacity: 1; }


    /* Popup nh·∫≠p m·∫≠t kh·∫©u */
    #passwordPopup {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
    }


    #popupBox {
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 300px;
        text-align: center;
    }


    input {
        width: 90%;
        padding: 8px;
        margin-top: 10px;
    }


    button {
        padding: 10px 20px;
        margin: 10px;
        cursor: pointer;
    }


    #connectBtn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    /* Loading ki·ªÉu iPhone */
#loadingBox {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    justify-content: center;
    align-items: center;
}


.loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 0.8s linear infinite;
}

#connectedPopup {
    position: fixed; 
    top:0; left:0; 
    width:100%; 
    height:100%;
    background: rgba(0,0,0,0.5); 
    display:none;
    justify-content:center; 
    align-items:center;
}

#connectedPopupBox {
    background:white; 
    padding:20px; 
    border-radius:8px; 
    width:300px; 
    text-align:center;
}


@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}


</style>
</head>
<body>


<h2>C·∫•u h√¨nh WiFi ESP32</h2>


<div class="center-btn">
    <button onclick="scanWifi()">Scan WiFi</button>
</div>


<div id="wifiList"></div>

<!-- Popup nh·∫≠p m·∫≠t kh·∫©u -->
<div id="passwordPopup">
    <div id="popupBox">
        <h3 id="popupSSID"></h3>
        <input type="password" id="passwordInput" placeholder="Nh·∫≠p m·∫≠t kh·∫©u WiFi">
        <br>
        <button id="connectBtn" disabled onclick="connectWifi()">K·∫øt n·ªëi</button>
        <button onclick="closePopup()">H·ªßy b·ªè</button>
    </div>
    <div id="loadingBox">
        <div class="loader"></div>
    </div>


</div>


<div id="connectedPopup" onclick="outsideClick(event)">
    <div id="connectedPopupBox" onclick="event.stopPropagation()">
        <h3 id="connectedSSIDName"></h3>
        <button onclick="forgetNetwork()">Qu√™n m·∫°ng n√†y</button>
        <button onclick="disconnectNetwork()">Ng·∫Øt k·∫øt n·ªëi</button>
    </div>
</div>



<script>

let selectedSSID = "";
let connectedSSID = "";

let scanInProgress = false;
function scanWifi() {
    if (scanInProgress) return;
    scanInProgress = true;
    connectedSSID = "";

    // 1Ô∏è‚É£ g·ª≠i l·ªánh b·∫Øt ƒë·∫ßu scan
    fetch("/scan_wifi")
            .then(res => res.json())
            .then(data => {
                if (data.status === "scanning") {
                    // ƒëang scan ‚Üí kh√¥ng l√†m g√¨, ch·ªù v√≤ng sau
                    document.getElementById("wifiList").innerHTML = "ƒêang qu√©t WiFi...";
                    return;
                }
            })
            .catch(err => {
                clearInterval(timer);
                console.error("Scan error:", err);
            });

    // 2Ô∏è‚É£ poll k·∫øt qu·∫£
    const timer = setInterval(() => {
        fetch("/scan_result")
            .then(res => res.json())
            .then(data => {
                if (data.status === "running") {
                    // ƒëang scan ‚Üí kh√¥ng l√†m g√¨, ch·ªù v√≤ng sau
                    console.log("WiFi running...");
                    return;
                }

                if (data.status === "done") {
                    scanInProgress = false;
                    clearInterval(timer);
                    console.log("Done");
                    if (Array.isArray(data.aps)) {
                        renderWifiList(data.aps);
                    } else {
                        document.getElementById("wifiList").innerHTML =
                            "Kh√¥ng t√¨m th·∫•y WiFi";
                    }
                }
            })
            .catch(err => {
                clearInterval(timer);
                console.error("Scan error:", err);
            });
    }, 2000); // ‚¨ÖÔ∏è ƒë√∫ng y√™u c·∫ßu: 2 gi√¢y
}



function renderWifiList(data) {
    let html = "";
    data.forEach(wifi => {
        let lockIcon = wifi.secure ? "üîí" : "";
        let level = rssiToLevel(wifi.rssi);


        let status = (wifi.ssid === connectedSSID)
            ? `<span style="color:green; font-weight:bold;"> ƒê√£ k·∫øt n·ªëi</span>`
            : "";


        html += `
            <div class="wifi-item" onclick="wifiClicked('${wifi.ssid}', ${wifi.secure})">
                <div class="wifi-name">${wifi.ssid}</div>
                <div class="icons">
                    ${status}
                    <span class="lock">${lockIcon}</span>
                    <div class="wifi-icon wifi-signal-${level}">
                        <span class="bar1"></span>
                        <span class="bar2"></span>
                        <span class="bar3"></span>
                        <span class="bar4"></span>
                    </div>
                </div>
            </div>
        `;
    });
    document.getElementById("wifiList").innerHTML = html;
}


function rssiToLevel(rssi) {
    if (rssi > -50) return 4;
    if (rssi > -65) return 3;
    if (rssi > -75) return 2;
    return 1;
}


function wifiClicked(ssid, secure) {
    selectedSSID = ssid;


    // N·∫øu nh·∫•n v√†o WiFi ƒëang k·∫øt n·ªëi ‚Üí m·ªü popup t√πy ch·ªçn
    if (ssid === connectedSSID) {
        document.getElementById("connectedSSIDName").innerText = ssid;
        document.getElementById("connectedPopup").style.display = "flex";
        return;
    }


    // N·∫øu WiFi kh√¥ng c√≥ m·∫≠t kh·∫©u ‚Üí k·∫øt n·ªëi ngay
    if (!secure) {
        connectedSSID = ssid;
        renderWifiList();
        alert("ƒê√£ k·∫øt n·ªëi t·ªõi " + ssid);
        return;
    }


    // N·∫øu WiFi c√≥ m·∫≠t kh·∫©u ‚Üí m·ªü popup nh·∫≠p m·∫≠t kh·∫©u
    document.getElementById("popupSSID").innerText = ssid;
    document.getElementById("passwordPopup").style.display = "flex";
}


function closePopup() {
    document.getElementById("passwordPopup").style.display = "none";
    document.getElementById("passwordInput").value = "";
    document.getElementById("connectBtn").disabled = true;
}


document.getElementById("passwordInput").addEventListener("input", function() {
    document.getElementById("connectBtn").disabled = this.value.length < 8;
});


// K·∫øt n·ªëi WiFi
function connectWifi() {
    let pass = document.getElementById("passwordInput").value;

    if (!selectedSSID || !pass) {
        alert("Thi·∫øu SSID ho·∫∑c m·∫≠t kh·∫©u");
        return;
    }

    // Loading
    document.getElementById("loadingBox").style.display = "flex";


    setTimeout(() => {  
        fetch("/connect_wifi", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                ssid: selectedSSID,
                password: pass
            })
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById("loadingBox").style.display = "none";

            if (data.status === "ok") {
                connectedSSID = selectedSSID;
                closePopup();
                renderWifiList();
                alert("K·∫øt n·ªëi th√†nh c√¥ng t·ªõi " + selectedSSID);
            } else {
                alert(data.message || "K·∫øt n·ªëi th·∫•t b·∫°i");
                document.getElementById("passwordInput").value = "";
                document.getElementById("connectBtn").disabled = true;
            }
        })
        .catch(err => {
            document.getElementById("loadingBox").style.display = "none";
            alert("L·ªói k·∫øt n·ªëi ESP32");
            console.error(err);
        });
    }, 1500);
}


// Popup: Qu√™n m·∫°ng n√†y
function forgetNetwork() {
    alert("ƒê√£ qu√™n");
    connectedSSID = "";
    document.getElementById("connectedPopup").style.display = "none";
    renderWifiList();
}


// Popup: Ng·∫Øt k·∫øt n·ªëi
function disconnectNetwork() {
    alert("ƒê√£ ng·∫Øt");
    connectedSSID = "";
    document.getElementById("connectedPopup").style.display = "none";
    renderWifiList();
}


// ƒê√≥ng popup k·∫øt n·ªëi hi·ªán t·∫°i
function closeConnectedPopup() {
    document.getElementById("connectedPopup").style.display = "none";
}
function outsideClick(event) {
    // N·∫øu click v√†o n·ªÅn (kh√¥ng ph·∫£i khung popup)
    if (event.target.id === "passwordPopup") {
        closePopup();
    }


    if (event.target.id === "connectedPopup") {
        closeConnectedPopup();
    }
}
</script>
</body>
</html>