<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ESP32 WiFi Config</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        padding: 20px;
    }

    h2 { text-align: center; }

    .center-btn {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    #wifiList {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .wifi-item {
        background: white;
        padding: 12px;
        width: 500px;
        margin-bottom: 8px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        border: 1px solid #ddd;
    }


    .wifi-name {
        font-size: 16px;
        font-weight: bold;
    }


    .icons {
        display: flex;
        gap: 10px;
        align-items: center;
    }


    .lock {
        color: #d9534f;
        font-size: 18px;
    }


    /* ICON S√ìNG WIFI KI·ªÇU iPHONE */
    .wifi-icon {
        width: 22px;
        height: 18px;
        position: relative;
        display: inline-block;
    }


    .wifi-icon span {
        position: absolute;
        bottom: 0;
        width: 4px;
        background: #000;
        border-radius: 2px;
        opacity: 0.2;
    }


    .wifi-icon .bar1 { height: 4px; left: 0px; }
    .wifi-icon .bar2 { height: 8px; left: 6px; }
    .wifi-icon .bar3 { height: 12px; left: 12px; }
    .wifi-icon .bar4 { height: 16px; left: 18px; }


    .wifi-signal-1 .bar1 { opacity: 1; }
    .wifi-signal-2 .bar1, .wifi-signal-2 .bar2 { opacity: 1; }
    .wifi-signal-3 .bar1, .wifi-signal-3 .bar2, .wifi-signal-3 .bar3 { opacity: 1; }
    .wifi-signal-4 .bar1, .wifi-signal-4 .bar2, .wifi-signal-4 .bar3, .wifi-signal-4 .bar4 { opacity: 1; }


    /* Popup nh·∫≠p m·∫≠t kh·∫©u */
    #passwordPopup {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
    }


    #popupBox {
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 300px;
        text-align: center;
    }


    input {
        width: 90%;
        padding: 8px;
        margin-top: 10px;
    }


    button {
        padding: 10px 20px;
        margin: 10px;
        cursor: pointer;
        border-radius: 6px;
        color: white;
        border: none;
    }

    #scan_wifi {
        background: #3498db;
    }

    #forget_wifi {
        background: #c9302c;
    }

    #disconnect_wifi {
        background: #3498db;
    }

    #connectBtn {
        background: #3498db;
    }

    #closeBtn {
        background: #c9302c;
    }

    #connectBtn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    /* Loading ki·ªÉu iPhone */
#loadingBox {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    justify-content: center;
    align-items: center;
}


.loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 0.8s linear infinite;
}

#connectedPopup {
    position: fixed; 
    top:0; left:0; 
    width:100%; 
    height:100%;
    background: rgba(0,0,0,0.5); 
    display:none;
    justify-content:center; 
    align-items:center;
}

#connectedPopupBox {
    background:white; 
    padding:20px; 
    border-radius:8px; 
    width:300px; 
    text-align:center;
}
#exitBar {
    position: fixed;
    top: 12px;
    right: 16px;
    z-index: 1000;
}

#exitBtn {
    background: #d9534f;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
}

#exitBtn:hover {
    background: #c9302c;
}


@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}


</style>
</head>
<body>

<div id="exitBar">
    <button id="exitBtn" onclick="exitAP()">Tho√°t</button>
</div>
<h2>C·∫•u h√¨nh WiFi ESP32</h2>
<div class="center-btn">
    <button id="scan_wifi" onclick="scanWifi()">Scan WiFi</button>
</div>


<div id="wifiList"></div>

<!-- Popup nh·∫≠p m·∫≠t kh·∫©u -->
<div id="passwordPopup">
    <div id="popupBox">
        <h3 id="popupSSID"></h3>
        <input type="password" id="passwordInput" placeholder="Nh·∫≠p m·∫≠t kh·∫©u WiFi">
        <br>
        <button id="connectBtn" disabled onclick="connectWifi()">K·∫øt n·ªëi</button>
        <button id="closeBtn" onclick="closePopup()">H·ªßy b·ªè</button>
    </div>
    <div id="loadingBox">
        <div class="loader"></div>
    </div>


</div>


<div id="connectedPopup" onclick="outsideClick(event)">
    <div id="connectedPopupBox" onclick="event.stopPropagation()">
        <h3 id="connectedSSIDName"></h3>
        <button id="forget_wifi" onclick="forgetNetwork()">Qu√™n m·∫°ng n√†y</button>
        <button id="disconnect_wifi" onclick="disconnectNetwork()">Ng·∫Øt k·∫øt n·ªëi</button>
    </div>
</div>
<script>

let selectedSSID = "";
let connectedSSID = "";
let lastScanResult = [];
let scanInProgress = false;
let connectedWifiTimer = null;
document.addEventListener("DOMContentLoaded", () => {
    fetchConnectedWifi();          // g·ªçi ngay l·∫ßn ƒë·∫ßu
    startConnectedWifiPolling();   // sau ƒë√≥ poll m·ªói 2s
});

function startConnectedWifiPolling() {
    // Tr√°nh t·∫°o nhi·ªÅu timer
    if (connectedWifiTimer) return;

    connectedWifiTimer = setInterval(() => {
        fetchConnectedWifi();
    }, 2000);
}

function stopConnectedWifiPolling() {
    if (connectedWifiTimer) {
        clearInterval(connectedWifiTimer);
        connectedWifiTimer = null;
    }
}

function showScanHint(text) {
    let hint = document.getElementById("scanHint");
    if (!hint) {
        hint = document.createElement("div");
        hint.id = "scanHint";
        hint.style.textAlign = "center";
        hint.style.marginTop = "10px";
        document.body.insertBefore(hint, document.getElementById("wifiList"));
    }
    hint.innerText = text;
}

function scanWifi() {
    if (scanInProgress) return;
    scanInProgress = true;

    showScanHint("ƒêang qu√©t WiFi...");

    fetch("/scan_wifi");

    const timer = setInterval(() => {
        fetch("/scan_result")
            .then(res => res.json())
            .then(data => {
                if (data.status === "running") return;

                if (data.status === "done") {
                    scanInProgress = false;
                    clearInterval(timer);

                    lastScanResult = data.aps || [];
                    renderWifiList(lastScanResult);
                    showScanHint("");
                }
            })
            .catch(() => {
                scanInProgress = false;
                clearInterval(timer);
                showScanHint("Scan l·ªói");
            });
    }, 2000);
}


function renderWifiList(list = lastScanResult) {
    let html = "";
    let hasConnectedInList = false;

    list.forEach(wifi => {
        const isThisSSID = wifi.ssid === connectedSSID;
        if (isThisSSID) hasConnectedInList = true;

        let statusText = "";
        if (isThisSSID) {
            if (wifiState === "got_ip") {
                statusText = '<span style="color:green">ƒê√£ k·∫øt n·ªëi</span>';
            } else if (wifiState === "reconnecting") {
                statusText = '<span style="color:orange">M·∫•t k·∫øt n·ªëi</span>';
            } else if (wifiState === "fail") {
                statusText = '<span style="color:red">K·∫øt n·ªëi l·ªói</span>';
            }
        }

        html += `
        <div class="wifi-item"
             onclick="wifiClicked('${escapeJS(wifi.ssid)}', ${wifi.secure})">
            <div class="wifi-name">${wifi.ssid}</div>
            <div class="icons">
                ${statusText}
                ${wifi.secure ? 'üîí' : ''}
            </div>
        </div>`;
    });

    // WiFi ƒë√£ t·ª´ng k·∫øt n·ªëi nh∆∞ng kh√¥ng c√≤n trong scan
    if (connectedSSID && !hasConnectedInList) {
        let statusText =
            wifiState === "got_ip" ? "ƒê√£ k·∫øt n·ªëi" :
            wifiState === "reconnecting" ? "M·∫•t k·∫øt n·ªëi" :
            "Kh√¥ng k·∫øt n·ªëi";

        html =
        `
        <div class="wifi-item"
             onclick="wifiClicked('${escapeJS(connectedSSID)}', true)">
            <div class="wifi-name">${connectedSSID}</div>
            <div class="icons">
                <span>${statusText}</span>
            </div>
        </div>
        ` + html;
    }

    document.getElementById("wifiList").innerHTML = html;
}




function rssiToLevel(rssi) {
    if (rssi > -50) return 4;
    if (rssi > -65) return 3;
    if (rssi > -75) return 2;
    return 1;
}


function wifiClicked(ssid, secure) {
    selectedSSID = ssid;


    // N·∫øu nh·∫•n v√†o WiFi ƒëang k·∫øt n·ªëi ‚Üí m·ªü popup t√πy ch·ªçn
    if (ssid === connectedSSID) {
        document.getElementById("connectedSSIDName").innerText = ssid;
        document.getElementById("connectedPopup").style.display = "flex";
        return;
    }


    // N·∫øu WiFi kh√¥ng c√≥ m·∫≠t kh·∫©u ‚Üí k·∫øt n·ªëi ngay
    if (!secure) {
        document.getElementById("loadingBox").style.display = "flex";

        fetch("/connect_wifi", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                ssid: ssid,
                password: ""
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "ok") {
                startWifiStatusPolling();
            } else {
                document.getElementById("loadingBox").style.display = "none";
                alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi WiFi");
            }
        });

        return;
    }


    // N·∫øu WiFi c√≥ m·∫≠t kh·∫©u ‚Üí m·ªü popup nh·∫≠p m·∫≠t kh·∫©u
    document.getElementById("popupSSID").innerText = ssid;
    document.getElementById("passwordPopup").style.display = "flex";
}


function closePopup() {
    document.getElementById("passwordPopup").style.display = "none";
    document.getElementById("passwordInput").value = "";
    document.getElementById("connectBtn").disabled = true;
}


document.getElementById("passwordInput").addEventListener("input", function() {
    document.getElementById("connectBtn").disabled = this.value.length < 8;
});


let wifiStatusTimer = null;

function connectWifi() {
    const pass = document.getElementById("passwordInput").value;

    if (!selectedSSID || pass.length < 8) {
        alert("SSID ho·∫∑c m·∫≠t kh·∫©u kh√¥ng h·ª£p l·ªá");
        return;
    }

    document.getElementById("loadingBox").style.display = "flex";

    fetch("/connect_wifi", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            ssid: selectedSSID,
            password: pass
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "ok") {
            startWifiStatusPolling();
        } else {
            stopWifiStatusPolling();
            document.getElementById("loadingBox").style.display = "none";
            alert("Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu k·∫øt n·ªëi WiFi");
        }
    })
    .catch(err => {
        stopWifiStatusPolling();
        document.getElementById("loadingBox").style.display = "none";
        alert("L·ªói k·∫øt n·ªëi t·ªõi ESP32");
        console.error(err);
    });
}

function startWifiStatusPolling() {
    stopWifiStatusPolling(); // tr√°nh tr√πng timer

    wifiStatusTimer = setInterval(() => {
        fetch("/wifi_status")
            .then(res => res.json())
            .then(data => {
                console.log("WiFi status:", data.status);

                if (data.status === "connecting") {
                    // v·∫´n ƒëang k·∫øt n·ªëi ‚Üí kh√¥ng l√†m g√¨
                    return;
                }

                if (data.status === "got_ip") {
                    connectedSSID = selectedSSID;
                    stopWifiStatusPolling();
                    document.getElementById("loadingBox").style.display = "none";
                    closePopup();
                    renderWifiList();
                    return;
                }

                if (data.status === "fail") {
                    stopWifiStatusPolling();
                    document.getElementById("loadingBox").style.display = "none";
                    alert("K·∫øt n·ªëi WiFi th·∫•t b·∫°i (sai m·∫≠t kh·∫©u ho·∫∑c AP kh√¥ng ph·∫£n h·ªìi)");
                }
            })
            .catch(err => {
                stopWifiStatusPolling();
                document.getElementById("loadingBox").style.display = "none";
                alert("M·∫•t k·∫øt n·ªëi t·ªõi ESP32");
                console.error(err);
            });
    }, 2000); // poll m·ªói 2 gi√¢y
}

function stopWifiStatusPolling() {
    if (wifiStatusTimer) {
        clearInterval(wifiStatusTimer);
        wifiStatusTimer = null;
    }
}
// Popup: Qu√™n m·∫°ng n√†y
function forgetNetwork() {
    fetch("/forget_wifi", { method: "POST" })
        .then(res => res.json())
        .then(data => {
            if (data.status === "ok") {
                connectedSSID = "";
                document.getElementById("connectedPopup").style.display = "none";

                // ch·ªâ render l·∫°i UI
                renderWifiList();
            } else {
                alert("Qu√™n WiFi th·∫•t b·∫°i");
            }
        })
        .catch(() => alert("M·∫•t k·∫øt n·ªëi t·ªõi ESP32"));
}


// Popup: Ng·∫Øt k·∫øt n·ªëi
function disconnectNetwork() {
    fetch("/disconnect_wifi", { method: "POST" })
        .then(res => res.json())
        .then(data => {
            if (data.status === "ok") {
                connectedSSID = "";
                document.getElementById("connectedPopup").style.display = "none";

                renderWifiList();
            } else {
                alert("Ng·∫Øt k·∫øt n·ªëi th·∫•t b·∫°i");
            }
        })
        .catch(() => alert("M·∫•t k·∫øt n·ªëi t·ªõi ESP32"));
}

function exitAP() {
    fetch("/exit_ap", { method: "POST" })
        .then(res => res.json())
        .then(data => {
            if (data.status === "ok") {

                /*
                 * Khi ESP t·∫Øt AP:
                 * - Browser s·∫Ω m·∫•t k·∫øt n·ªëi WiFi
                 * - reload ngay c√≥ th·ªÉ fail
                 * ‚Üí delay nh·∫π cho an to√†n
                 */
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert("Tho√°t AP th·∫•t b·∫°i");
            }
        })
        .catch(err => {
            console.error(err);
            alert("Kh√¥ng th·ªÉ g·ª≠i l·ªánh tho√°t AP");
        });
}


// ƒê√≥ng popup k·∫øt n·ªëi hi·ªán t·∫°i
function closeConnectedPopup() {
    document.getElementById("connectedPopup").style.display = "none";
}
function outsideClick(event) {
    // N·∫øu click v√†o n·ªÅn (kh√¥ng ph·∫£i khung popup)
    if (event.target.id === "passwordPopup") {
        closePopup();
    }


    if (event.target.id === "connectedPopup") {
        closeConnectedPopup();
    }
}

function fetchConnectedWifi() {
    fetch("/wifi_current", { method: "GET" })
        .then(res => res.json())
        .then(data => {
            if (data.connected) {
                connectedSSID = data.ssid;
                wifiState = "got_ip";
            } else {
                wifiState = "idle";
            }
            renderWifiList();
        })
        .catch(() => {
            wifiState = "idle";
        });
}

function escapeJS(str) {
    return str.replace(/\\/g, "\\\\").replace(/'/g, "\\'");
}
</script>
</body>
</html>